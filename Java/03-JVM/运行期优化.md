# 1 å³æ—¶ç¼–è¯‘
## 1.1 åˆ†å±‚ç¼–è¯‘ï¼ˆTieredCompilationï¼‰
å…ˆæ¥ä¸ªä¾‹å­

```java
public class JIT1 {
    public static void main(String[] args) {
        for (int i = 0; i < 200; i++) {
            long start = System.nanoTime();
            for (int j = 0; j < 1000; j++) {
                new Object();
            }
            long end = System.nanoTime();
            System.out.printf("%d\t%d
",i,(end - start));
        }
    }
}
```

```java
0	59028
1	58233
2	45818
3	44093
4	42546
5	65791
6	43380
7	26173
8	32455
9	25052
10	24917
11	32560
12	40064
13	40577
14	42589
15	43008
16	49930
17	42601
18	36272
19	26315
20	59480
21	39777
22	40964
23	38979
24	40258
25	36950
26	43152
27	45393
28	49302
29	45288
30	43948
31	48568
32	133657
33	88518
34	46010
35	46068
36	55863
37	49931
38	44253
39	57264
40	47153
41	47659
42	45230
43	191617
44	508762
45	44888
46	41801
47	72912
48	47011
49	45289
50	53457
51	40001
52	52688
53	49616
54	60323
55	72496
56	64932
57	36613
58	60884
59	28578
60	39777
61	56570
62	63878
63	44510
64	46598
65	57416
66	42117
67	52975
68	42338
69	41716
70	38013
71	38840
72	34408
73	15416
74	18868
75	17576
76	17727
77	13684
78	56029
79	18095
80	16767
81	13834
82	26410
83	21249
84	16714
85	17256
86	19226
87	19123
88	17564
89	17319
90	18024
91	19663
92	47495
93	17634
94	23092
95	19234
96	18558
97	169143
98	18386
99	18310
100	18031
101	17705
102	24715
103	34894
104	15096
105	18130
106	17791
107	38036
108	32336
109	17193
110	18426
111	18552
112	16151
113	19484
114	17612
115	15043
116	18547
117	47226
118	15489
119	17921
120	16595
121	12711
122	17777
123	18461
124	15708
125	23101
126	18555
127	17040
128	15471
129	17037
130	17717
131	13737
132	16890
133	18867
134	17839
135	15043
136	18039
137	19149
138	41502
139	18004
140	25612
141	79004
142	49807
143	647
144	622
145	651
146	657
147	623
148	620
149	623
150	630
151	627
152	626
153	627
154	624
155	627
156	627
157	625
158	624
159	619
160	652
161	641
162	654
163	703
164	661
165	756
166	681
167	659
168	659
169	664
170	664
171	679
172	683
173	651
174	664
175	679
176	659
177	680
178	707
179	665
180	735
181	785
182	718
183	658
184	690
185	662
186	668
187	684
188	688
189	644
190	723
191	697
192	856
193	665
194	670
195	675
196	683
197	683
198	700
199	639
```

åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ  
JVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

+ 0 å±‚ï¼Œè§£é‡Šæ‰§è¡Œï¼ˆInterpreterï¼‰
+ 1 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ profilingï¼‰
+ 2 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„ profilingï¼‰
+ 3 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„ profilingï¼‰
+ 4 å±‚ï¼Œä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œ

profiling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚ã€æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€‘ï¼Œã€å¾ªç¯çš„å›è¾¹æ¬¡æ•°ã€‘ç­‰

å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¸è§£é‡Šå™¨çš„åŒºåˆ«

+ è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºæœºå™¨ç ï¼Œä¸‹æ¬¡å³ä½¿é‡åˆ°ç›¸åŒçš„å­—èŠ‚ç ï¼Œä»ä¼šæ‰§è¡Œé‡å¤çš„è§£é‡Š
+ JIT æ˜¯å°†ä¸€äº›å­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œå¹¶å­˜å…¥ Code Cacheï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€å†ç¼–è¯‘
+ è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºé’ˆå¯¹æ‰€æœ‰å¹³å°éƒ½é€šç”¨çš„æœºå™¨ç 
+ JIT ä¼šæ ¹æ®å¹³å°ç±»å‹ï¼Œç”Ÿæˆå¹³å°ç‰¹å®šçš„æœºå™¨ç 

å¯¹äºå æ®å¤§éƒ¨åˆ†çš„ä¸å¸¸ç”¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ— éœ€è€—è´¹æ—¶é—´å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯é‡‡å–è§£é‡Šæ‰§è¡Œçš„æ–¹å¼è¿è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹äºä»…å æ®å°éƒ¨åˆ†çš„çƒ­ç‚¹ä»£ç ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»¥è¾¾åˆ°ç†æƒ³çš„è¿è¡Œé€Ÿåº¦ã€‚ æ‰§è¡Œæ•ˆç‡ä¸Šç®€å•æ¯”è¾ƒä¸€ä¸‹ `Interpreter < C1 < C2`ï¼Œæ€»çš„ç›®æ ‡æ˜¯å‘ç°çƒ­ç‚¹ä»£ç ï¼ˆhotspotåç§°çš„ç”±æ¥ï¼‰ï¼Œä¼˜åŒ–ä¹‹ã€‚  
åˆšæ‰çš„ä¸€ç§ä¼˜åŒ–æ‰‹æ®µç§°ä¹‹ä¸ºã€é€ƒé€¸åˆ†æã€‘ï¼Œå‘ç°æ–°å»ºçš„å¯¹è±¡æ˜¯å¦é€ƒé€¸ã€‚å¯ä»¥ä½¿ç”¨`-XX:-DoEscapeAnalysis`å…³é—­é€ƒé€¸åˆ†æï¼Œå†è¿è¡Œåˆšæ‰çš„ç¤ºä¾‹è§‚å¯Ÿç»“æœ  
å‚è€ƒèµ„æ–™ï¼š[https://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machineperformance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4](https://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machineperformance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4)

## 1.2 æ–¹æ³•å†…è”
Inlining

```java
private static int square(final int i) {
    return i * i;
}
```

```java
System.out.println(square(9));
```

å¦‚æœå‘ç° square æ˜¯çƒ­ç‚¹æ–¹æ³•ï¼Œå¹¶ä¸”é•¿åº¦ä¸å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡Œå†…è”ï¼Œæ‰€è°“çš„å†…è”å°±æ˜¯æŠŠæ–¹æ³•å†…ä»£ç æ‹·è´ã€ç²˜è´´åˆ°è°ƒç”¨è€…çš„ä½ç½®ï¼š

```java
System.out.println(9 * 9);
```

è¿˜èƒ½å¤Ÿè¿›è¡Œå¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰çš„ä¼˜åŒ–

```java
System.out.println(81);
```

å®éªŒï¼š

```java
public class JIT2 {
    // -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining ï¼ˆè§£é”éšè—å‚æ•°ï¼‰æ‰“å°inlining ä¿¡æ¯
    // -XX:CompileCommand=dontinline,*JIT2.square ç¦æ­¢æŸä¸ªæ–¹æ³• inlining
    // -XX:+PrintCompilation æ‰“å°ç¼–è¯‘ä¿¡æ¯
    public static void main(String[] args) {
        int x = 0;
        for (int i = 0; i < 500; i++) {
            long start = System.nanoTime();
            for (int j = 0; j < 1000; j++) {
                x = square(9);
            }
            long end = System.nanoTime();
            System.out.printf("%d\t%d\t%d
",i,x,(end - start));
        }
    }
    private static int square(final int i) {
        return i * i;
    }
}
```

##   
1.3 å­—æ®µä¼˜åŒ–
JMH åŸºå‡†æµ‹è¯•è¯·å‚è€ƒï¼š[http://openjdk.java.net/projects/code-tools/jmh/](http://openjdk.java.net/projects/code-tools/jmh/)  
åˆ›å»º maven å·¥ç¨‹ï¼Œæ·»åŠ ä¾èµ–å¦‚ä¸‹

```java
<dependency>
    <groupId>org.openjdk.jmh</groupId>
    jmh-core</artifactId>
    <version>${jmh.version}</version>
</dependency>
<dependency>
    <groupId>org.openjdk.jmh</groupId>
    jmh-generator-annprocess</artifactId>
    <version>${jmh.version}</version>
    <scope>provided</scope>
</dependency>
```

ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç ï¼š

```java
package test;
import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.runner.Runner;
import org.openjdk.jmh.runner.RunnerException;
import org.openjdk.jmh.runner.options.Options;
import org.openjdk.jmh.runner.options.OptionsBuilder;
import java.util.Random;
import java.util.concurrent.ThreadLocalRandom;

@Warmup(iterations  = 2, time = 1) 
@Measurement(iterations  = 5, time = 1) 
@State(Scope.Benchmark)  
public class Benchmark1 {
    int[] elements = randomInts(1_000);
        
    private static int[] randomInts(int size) {
        Random random = ThreadLocalRandom.current();
        int[] values = new int[size];
        for (int i = 0; i < size; i++) {
            values[i] = random.nextInt();
        }
        return values;
    }
        
    @Benchmark  
    public void test1() {
        for (int i = 0; i < elements.length; i++) {
            doSum(elements[i]);
        }
    }
        
    @Benchmark  
    public void test2() {
        int[] local = this.elements;
        for (int i = 0; i < local.length; i++) {
            doSum(local[i]);
        }
    }
        
    @Benchmark  
    public void test3() {
        for (int element : elements) {
            doSum(element);
        }
    }
        
    static int sum = 0;
    
    @CompilerControl(CompilerControl.Mode.INLINE)
    static void doSum(int x) {
        sum += x;
    }
        
    public static void main(String[] args) throws RunnerException {
        Options opt = new OptionsBuilder()
            .include(Benchmark1.class.getSimpleName())
            .forks(1)
            .build();
        new Runner(opt).run();
    }
}
```

é¦–å…ˆå¯ç”¨ doSum çš„æ–¹æ³•å†…è”ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼ˆæ¯ç§’ååé‡ï¼Œåˆ†æ•°è¶Šé«˜çš„æ›´å¥½ï¼‰ï¼š

```plain
Benchmark 						Mode 		Samples 		Score 				Score error 		Units
t.Benchmark1.test1 		thrpt 			5 		2420286.539 		390747.467 			ops/s
t.Benchmark1.test2 		thrpt 			5 		2544313.594 		91304.136 			ops/s
t.Benchmark1.test3 		thrpt 			5 		2469176.697 		450570.647 			ops/s
```

æ¥ä¸‹æ¥ç¦ç”¨ doSum æ–¹æ³•å†…è”

```java
@CompilerControl(CompilerControl.Mode.DONT_INLINE)
    static void doSum(int x) {
        sum += x;
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```java
Benchmark 				Mode 		Samples 	Score 		Score error 	Units
t.Benchmark1.test1 		thrpt 		5 			296141.478 	63649.220 		ops/s
t.Benchmark1.test2 		thrpt 		5 			371262.351 	83890.984 		ops/s
t.Benchmark1.test3 		thrpt 		5 			368960.847 	60163.391 		ops/s
```

åˆ†æï¼š  
åœ¨åˆšæ‰çš„ç¤ºä¾‹ä¸­ï¼ŒdoSum æ–¹æ³•æ˜¯å¦å†…è”ä¼šå½±å“ elements æˆå‘˜å˜é‡è¯»å–çš„ä¼˜åŒ–ï¼š  
å¦‚æœ doSum æ–¹æ³•å†…è”äº†ï¼Œåˆšæ‰çš„ test1 æ–¹æ³•ä¼šè¢«ä¼˜åŒ–æˆä¸‹é¢çš„æ ·å­ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```java
@Benchmark  
public void test1() {
    // elements.length é¦–æ¬¡è¯»å–ä¼šç¼“å­˜èµ·æ¥ -> int[] local
    for (int i = 0; i < elements.length; i++) { // åç»­ 999 æ¬¡ æ±‚é•¿åº¦ <- local
        sum += elements[i]; // 1000 æ¬¡å–ä¸‹æ ‡ i çš„å…ƒç´  <- local
    }
}
```

å¯ä»¥èŠ‚çœ 1999 æ¬¡ Field è¯»å–æ“ä½œ  
ä½†å¦‚æœ doSum æ–¹æ³•æ²¡æœ‰å†…è”ï¼Œåˆ™ä¸ä¼šè¿›è¡Œä¸Šé¢çš„ä¼˜åŒ–  
ç»ƒä¹ ï¼šåœ¨å†…è”æƒ…å†µä¸‹å°† elements æ·»åŠ  volatile ä¿®é¥°ç¬¦ï¼Œè§‚å¯Ÿæµ‹è¯•ç»“æœ  
  


# 2 åå°„ä¼˜åŒ–
```java
package cn.itcast.jvm.t3.reflect;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
public class Reflect1 {
    public static void foo() {
        System.out.println("foo...");
    }
    public static void main(String[] args) throws Exception {
        Method foo = Reflect1.class.getMethod("foo");
        for (int i = 0; i <= 16; i++) {
            System.out.printf("%d\t", i);
            foo.invoke(null);
        }
        System.in.read();
    }
}
```

foo.invoke å‰é¢ 0 ~ 15 æ¬¡è°ƒç”¨ä½¿ç”¨çš„æ˜¯ MethodAccessor çš„ NativeMethodAccessorImpl å®ç°  


```java
package sun.reflect;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import sun.reflect.misc.ReflectUtil;
class NativeMethodAccessorImpl extends MethodAccessorImpl {
    private final Method method;
    private DelegatingMethodAccessorImpl parent;
    private int numInvocations;
    
    NativeMethodAccessorImpl(Method method) {
        this.method = method;
    }
    
    public Object invoke(Object target, Object[] args)
    throws IllegalArgumentException, InvocationTargetException {
        // inflationThreshold è†¨èƒ€é˜ˆå€¼ï¼Œé»˜è®¤ 15
        if (++this.numInvocations > ReflectionFactory.inflationThreshold()
            && !ReflectUtil.isVMAnonymousClass(this.method.getDeclaringClass()))
        {
            // ä½¿ç”¨ ASM åŠ¨æ€ç”Ÿæˆçš„æ–°å®ç°ä»£æ›¿æœ¬åœ°å®ç°ï¼Œé€Ÿåº¦è¾ƒæœ¬åœ°å®ç°å¿« 20 å€å·¦å³
            MethodAccessorImpl generatedMethodAccessor =
                (MethodAccessorImpl)
                 (new MethodAccessorGenerator())
                 .generateMethod(
                     this.method.getDeclaringClass(),
                     this.method.getName(),
                     this.method.getParameterTypes(),
                     this.method.getReturnType(),
                     this.method.getExceptionTypes(),
                     this.method.getModifiers()
                 );
            this.parent.setDelegate(generatedMethodAccessor);
        }
        // è°ƒç”¨æœ¬åœ°å®ç°
        return invoke0(this.method, target, args);
    }
    void setParent(DelegatingMethodAccessorImpl parent) {
        this.parent = parent;
    }
    private static native Object invoke0(Method method, Object target, Object[]
                                         args);
}
```

å½“è°ƒç”¨åˆ°ç¬¬ 16 æ¬¡ï¼ˆä»0å¼€å§‹ç®—ï¼‰æ—¶ï¼Œä¼šé‡‡ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»ä»£æ›¿æ‰æœ€åˆçš„å®ç°ï¼Œå¯ä»¥é€šè¿‡ debug å¾—åˆ°ç±»åä¸º`sun.reflect.GeneratedMethodAccessor1`  
å¯ä»¥ä½¿ç”¨é˜¿é‡Œçš„ arthasï¼ˆé˜¿å°”è¨æ–¯ï¼‰ å·¥å…·ï¼š

arthaså®˜ç½‘ï¼š[https://arthas.aliyun.com/doc/quick-start.html](https://arthas.aliyun.com/doc/quick-start.html)

```java
java -jar arthas-boot.jar
[INFO] arthas-boot version: 3.1.1
[INFO] Found existing java process, please choose one and hit RETURN.
```

é€‰æ‹©å¯¹åº”çš„è¿›ç¨‹ï¼Œå›è½¦è¡¨ç¤ºåˆ†æè¯¥è¿›ç¨‹

![](images/532.png)  
å†è¾“å…¥ã€jad + ç±»åã€‘æ¥è¿›è¡Œåç¼–è¯‘

```java
$ jad sun.reflect.GeneratedMethodAccessor1
ClassLoader:
	+-sun.reflect.DelegatingClassLoader@15db9742
    	+-sun.misc.Launcher$AppClassLoader@4e0e2f2a
        	+-sun.misc.Launcher$ExtClassLoader@2fdb006e
Location:

/*
* Decompiled with CFR 0_132.
*
* Could not load the following classes:
*  cn.itcast.jvm.t3.reflect.Reflect1
*/
package sun.reflect;
import cn.itcast.jvm.t3.reflect.Reflect1;
import java.lang.reflect.InvocationTargetException;
import sun.reflect.MethodAccessorImpl;
public class GeneratedMethodAccessor1
    extends MethodAccessorImpl {
/*
* Loose catch block
* Enabled aggressive block sorting
* Enabled unnecessary exception pruning
* Enabled aggressive exception aggregation
* Lifted jumps to return sites
*/
    public Object invoke(Object object, Object[] arrobject) throws InvocationTargetException {
        // æ¯”è¾ƒå¥‡è‘©çš„åšæ³•ï¼Œå¦‚æœæœ‰å‚æ•°ï¼Œé‚£ä¹ˆæŠ›éæ³•å‚æ•°å¼‚å¸¸ 
        block4 : {
            if (arrobject == null || arrobject.length == 0) break block4;
            throw new IllegalArgumentException();
        }
		try {
    		// å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æ˜¯ç›´æ¥è°ƒç”¨äº†ğŸ˜±ğŸ˜±ğŸ˜± Reflect1.foo();
    		// å› ä¸ºæ²¡æœ‰è¿”å›å€¼
    		return null;
		}
		catch (Throwable throwable) {
    		throw new InvocationTargetException(throwable);
		}
		catch (ClassCastException | NullPointerException runtimeException) {
    		throw new IllegalArgumentException(Object.super.toString());
		} 
    }
}
Affect(row-cnt:1) cost in 1540 ms.
```

æ³¨æ„ï¼šé€šè¿‡æŸ¥çœ‹ ReflectionFactory æºç å¯çŸ¥

+ sun.reflect.noInflation å¯ä»¥ç”¨æ¥ç¦ç”¨è†¨èƒ€ï¼ˆç›´æ¥ç”Ÿæˆ GeneratedMethodAccessor1ï¼Œä½†é¦–æ¬¡ç”Ÿæˆæ¯”è¾ƒè€—æ—¶ï¼Œå¦‚æœä»…åå°„è°ƒç”¨ä¸€æ¬¡ï¼Œä¸åˆ’ç®—ï¼‰
+ sun.reflect.inflationThreshold å¯ä»¥ä¿®æ”¹è†¨èƒ€é˜ˆå€¼

